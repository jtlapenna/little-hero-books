// ADD VISUAL ANNOTATIONS TO GENERATED CHARACTER (n8n Compatible)
// This node adds clear visual cues to the custom character generated by Gemini
// Position: After "Process Gemini API response and extract generated image"

const items = $input.all();
const results = [];

for (let i = 0; i < items.length; i++) {
  const item = items[i];
  
  // Get the binary image data
  const imageBuffer = await this.helpers.getBinaryDataBuffer(i, 'data');
  if (!imageBuffer || imageBuffer.length < 1000) {
    throw new Error('Invalid image data for annotation');
  }
  
  // For now, we'll add metadata annotations and pass through the original image
  // The visual annotations will be handled by updating the pose references to use annotated versions
  
  // Prepare binary data (pass through original for now)
  const binaryData = await this.helpers.prepareBinaryData(
    imageBuffer, 
    'character-with-metadata.png', 
    'image/png'
  );
  
  // Return with enhanced metadata that makes the prompt clearer
  results.push({
    json: {
      ...item.json,
      _characterAnnotation: 'COPY_THIS_CHARACTER',
      _characterRole: 'SOURCE_OF_TRUTH',
      _visualCues: {
        borderColor: 'green',
        label: 'COPY THIS CHARACTER',
        role: 'SOURCE OF TRUTH'
      },
      _annotationVersion: 'V1_METADATA_ENHANCED'
    },
    binary: {
      data: binaryData
    }
  });
}

return results;
